---
layout: supply
---

<div id="login" style="display: none;">
  <p>Please type your email address below then press enter to begin login. Once you receive the token number that will be emailed to you, enter it below to continue.</p>
  <input autofocus id="pradmEmail" class="pradmEmail _oab_form" type="text" name="email" placeholder="email">
  <input id="pradmToken" class="pradmToken _oab_form" style="display:none;" type="text" name="token" placeholder="token (check your email)">
</div>

<div class="controls" style="display: none; float: right;">
  <a id="options" href="#">Options</a>
</div>

<div class="options" style="display: none; margin-top: 35px; margin-bottom: 5px;">
  <p style="text-align:right; margin-bottom: -50px;"><a id="pradmLogout" href="#">Logout</a></p>
  <p>
    Show <input type="radio" name="types" class="types" value="book"> books
    or <input type="radio" name="types" class="types" value="paper"> papers
  </p>

  <div id="filters">
    <input type="text" name="resolver" id="resolver" class="_oab_form" style="max-width: 24%; padding: 0px 12px; display: inline;" placeholder="Institutional link resolver URL">
  </div>
</div>

<p class="getresolver" style="display: none;">
  <a class="showresolver" href="#">Do you have an institutional link resolver?</a>
</p>
<p class="requestresolver" style="display: none;">
  If you are at an institution that has a link resolver, you can provide the URL for it here if you know it. 
  Then we can search the requests on your resolver and filter them to only show ones you will have access to.
  <input type="text" name="enterresolver" class="_oab_form enterresolver" placeholder="Enter your resolver URL here">
  <input type="checkbox" name="noresolver" class="noresolver"> I don't have a link resolver URL to provide
</p>
<p class="hasresolver" style="display: none;">
  <input type="checkbox" name="onlyresolved" class="onlyresolved"> Only show items your link resolver says you have access to
</p>

<table>
  <thead><tr></tr></thead>
  <tbody id="results"></tbody>
</table>

<div class="pradmLoading" style="display: none;">Loading...</div>



<script>
  window.api = window.location.host.indexOf('dev.') === 0 ? 'https://bgb.lvatn.com' : 'https://paradigm.oa.works';
  window.pradm = {};
  window.pradm.api = window.api;
</script>

<script src="https://bgb.lvatn.com/client/pradm.js"></script>
<script src="https://bgb.lvatn.com/client/pradmLogin.js"></script>

<script>
  /* global pradm */
  pradm.hide('#resolver'); // do this here so that it can be set with a non-standard display: inline above first
  
  var _first = true;
  var _max = false;
  var _from = 0;
  var _size = 50;
  var _paging = false;
  var _construct = function(r) {
    if (r._source) {
      var rid = r._id;
      r = r._source;
      if (!r._id) r._id = rid;
    }
    for ( var k in r ) r[k] = decodeURIComponent(r[k]); // clean up for old test data
    var body = '<tr><td>';
    var needsa = false;
    if (typeof r.doi === 'number') r.doi = r.doi.toString();
    if (r.doi && r.doi.startsWith('10.')) {
      needsa = true;
      body += '<a target="_blank" href="https://doi.org/' + r.doi + '">';
    } else if (r.pmid || r.doi) {
      if (!r.pmid) {
        var rd = r.doi.trim().toLowerCase().replace('pmid', '');
        if (rd.length < 10 && !isNaN(parseInt(rd))) r.pmid = rd;
      }
      if (r.pmid) {
        needsa = true;
        body += '<a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/' + r.pmid + '">';
      }
    } else if (r.atitle || r.title) {
      needsa = true;
      body += '<a target="_blank" href="https://scholar.google.com/scholar?q=' + encodeURIComponent(r.atitle ? r.atitle : r.title) + '">';
    }
    body += '<b>' + (r.atitle ? r.atitle : r.title) + '</b>' + (needsa ? '</a>' : '');
    if (r.year || r.publisher || (r.title && r.atitle))
      body += '<br>' + (r.year ? r.year + ' ' : '') + (r.title && r.atitle ? '<i><a class="title" href="#">' + r.title + '</a></i>' + (r.publisher ? ', ' : '') : '') + (r.publisher ? r.publisher : '');
    if (r.volume || r.issue || r.pages)
      body += '<br>' + (r.volume ? 'vol: ' + r.volume + ' ' : '') + (r.issue ? 'issue: ' + r.issue + ' ' : '') + (r.pages ? 'page(s): ' + r.pages : '');
    if (r.doi || r.issn || r.isbn)
      body += '<br>' + (r.doi && r.doi.startsWith('10.') ? '<a target="_blank" href="https://doi.org/' + r.doi + '">' + r.doi + '</a> ' : '') + (r.issn ? ' ISSN ' + r.issn : '') + (r.isbn ? ' ISBN ' + r.isbn : '');
    body += '</td><td>';

    body += '<div class="verified"' + (r.verified ? '' : ' style="display:none;"') + '>';
    body += '<a href="mailto:' + r.email + '?subject=RSCVD%20Request%20Receipt&body=';

    var msg = 'Hi ' + r.name + ',\n\nWe got your request of:\n\nTitle: ' + (r.atitle ? r.atitle : r.title) + '\nReference (if provided): ' + r.reference + '\n\n';
    msg += 'If at any point you no longer need this item, please <a href="https://dev.rscvd.org/update?cancel=' + r._id + '">cancel your request</a>, it only takes a second.\n\n';
    msg += 'Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.';

    body += encodeURIComponent(msg);
    body += '">' + r.email + '</a>';
    if (r['needed-by']) {
      body += '<br>Required by ' + r['needed-by'].split('-').reverse().join('/');
      if (r.reference) body += '<br>Ref: ' + r.reference;
    }
    if (r.status === 'Overdue' || r.status === 'Cancelled') {
      body += '<br><b>' + r.status + '</b>';
    } else {
      body += '<br><select class="_oab_form status ' + r._id + '">';
      var sopts = ['In progress', 'Awaiting Peter', 'Done'];
      if (!r.status || sopts.indexOf(r.status) === -1) body += '<option value="">Set a status...</option>';
      for (var s in sopts) {
        var st = sopts[s];
        body += '<option' + (r.status === st ? ' selected' : '') + '>' + st + '</option>';
      }
      body += '</select></div>';
    }

    body += '<div class="denied"' + (r.verified === false ? '' : ' style="display:none;""') + '><span style="color: red;">' + r.email + '</span><br>Request denied</div>';

    body += '<div class="verifier ' + r.email + '"' + (r.verified === undefined ? '' : ' style="display:none;"') + '>';
    body += (r.name ? r.name : r.email) + (r.organization ? (r.name ? ', ' : '') + r.organization : '');
    var nn = r.name ? r.name.split(' ')[0] : r.email.split('@')[0];
    body += '<br><a class="button action verify ' + r.email + '" href="#">Approve ' + nn + '</a><br><a class="button warning verify deny ' + r.email + '" href="#">Deny ' + nn + '</a>';
    body += '</div>';

    body += '</td></tr>';
    return body;
  }
  var _search = function() {
    if (!_paging) {
      _max = false;
      _from = 0;
      pradm.html('#results', '');
    }
    pradm.show('.pradmLoading');
    var url = '/svc/rscvd';
    var email = pradm.get('#email');
    var qry = 'email:' + (email ? '"' + email + '"' : '*');
    var title = pradm.get('#title');
    qry += ' AND ' + (title ? 'title.keyword:"' + title + '"' : '(title:* OR atitle:*)');
    var status = pradm.get('#status');
    if (status !== 'All') {
      qry += ' AND ' + (status ? 'status:"' + status + '"' : '(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter")');
    }
    pradm.each('.types', function(el) {
      if (pradm.checked(el)) qry += ' AND type:"' + pradm.get(el) + '"';
    });
    if (pradm.checked('.onlyresolver') && pradm.get('#resolver')) qry += ' AND resolves:"' + pradm.get('#resolver') + '"';
    url += '?q=' + qry + '&sort=createdAt:desc&size=' + _size + (_from ? '&from=' + _from : '');
    if (_first) url += '&terms=status,title'; // could get others such as email. Title will be hidden, but still provided for filtering convenience from title links in results
    pradm.ajax(url, {
      success: function(res) {
        if (res.hits.hits.length < _size) _max = true;
        for (var h in res.hits.hits) pradm.append('#results', _construct(res.hits.hits[h]));
        
        if (_first) {
          _first = false;
          if (res.aggregations) {
            for (var f in res.aggregations) {
              var fl = '<select class="_oab_form filter" id="' + f + '" style="max-width: 24%; display: inline;"><option value="">Filter by ' + f + '</option>';
              for (var b in res.aggregations[f].buckets) {
                fl += '<option>' + res.aggregations[f].buckets[b].key + '</option>';
              }
              if (f === 'status') fl += '<option>All</option>';
              fl += '</select>';
              pradm.append('#filters', fl);
            }
          }
          pradm.hide('#title'); // only keeping it as a handy way to pick up filter acounts from result title link clicks - gets shown if a user clicks one
          pradm.show('.controls');
        }
        pradm.hide('.pradmLoading');
        _paging = false;
        //window.history.pushState("", "", window.location.pathname + (q !== '' ? "?q=" + q : ''));
      }
    });
  };

  window.addEventListener('scroll', function () {
    if (!_max && !_paging && (window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
      _paging = true;
      _from += _size;
      _search();
    }
  });
  pradm.on("change", '.filter', _search);
  pradm.on("click", ".title", function(e) {
    e.preventDefault();
    pradm.set('#title', e.target.innerHTML);
    pradm.show('#title');
    _search();
  });
  pradm.listen("change", '.types', _search);
  pradm.on("click", '#options', function(e) { e.preventDefault(); pradm.toggle('.options'); });

  var _polls = undefined;
  var _lastpoll = Date.now();

  var _vd = function(el, email, deny) {
    if (!email) {
      var ce = pradm.classes(el).pop();
      if (_polls.verify.indexOf(ce) !== -1) {
        email = true;
      } else if (_polls.deny.indexOf(ce) !== -1) {
        email = true;
        deny = true;
      }
    }
    if (email === true || (email && pradm.has(el, '.' + email))) {
      pradm.hide(el);
      var siblings = pradm.siblings(el);
      for ( var s in siblings) {
        var sibling = siblings[s];
        if (pradm.has(sibling, 'verified')) {
          pradm[deny ? 'hide' : 'show'](sibling);
        } else if (pradm.has(sibling, 'denied')) {
          pradm[deny ? 'show' : 'hide'](sibling);
        }
      }
    }
  };
  
  var _state_hide = function(el) {
    if (['Done'].indexOf(el.value) !== -1) {
      pradm.class(el.closest('tr'), 'alert');
      setTimeout(function() {
        pradm.remove(el.closest('tr'));
      }, 500);
    }
  };
  
  pradm.on("click", ".verify", function(e) {
    e.preventDefault();
    var el = e.target;
    var cls = pradm.classes(el);
    var deny = cls.indexOf("deny") !== -1;
    pradm.html(el, (deny ? "Deny" : "Approv") + 'ing...');
    var email = cls.pop();
    pradm.ajax('/svc/rscvd/' + (deny ? "deny" : "verify") + "/" + email, {
      success: function(res) {
        if (res) pradm.each('.verifier', function(el) { _vd(el, email, deny); });
      }
    });
  });
  pradm.on("change", ".status", function(e) {
    var el = e.target;
    var cls = pradm.classes(el);
    pradm.ajax('/svc/rscvd/status/' + cls.pop() + "/" + el.value, {
      success: function(res) {
        if (res) _state_hide(el);
      }
    });
  });
  
  var _set_resolver = function(r) {
    pradm.hide('.requestresolver');
    pradm.cookie('resolver', r);
    if (r !== 'NONE') {
      pradm.set('#resolver', r);
      pradm.check('.onlyresolved');
      pradm.show('.hasresolver');
    } else {
      pradm.set('#resolver', '');
    }
    //pradm.ajax('/svc/rscvd/resolver/' + r);
    //pradm.show('#resolver');
    _search();
  };

  pradm.afterLogout = function() {
    window.location.reload();
  };
  var _doneafter = false;
  pradm.afterLogin = function() {
    if (!_doneafter) {
      _doneafter = true;
      pradm.listen('click', '.showresolver', function(e) {
        e.preventDefault();
        pradm.hide('.getresolver');
        pradm.show('.requestresolver');
      });
      pradm.listen('change', '.noresolver', function() { _set_resolver('NONE'); });
      pradm.listen('enter', '.enterresolver', function() { _set_resolver(pradm.get('.enterresolver')); });
      pradm.listen('enter', '#resolver', function() { console.log('resolve'); _set_resolver(pradm.get('#resolver')); });
      var r = pradm.cookie('resolver');
      if (r) {
        _set_resolver(r);
      } else {
        //pradm.show('.getresolver'); TODO UNCOMMENT THIS ONCE READY TO ENABLE LINK RESOLVER FOR USERS
        _search();
      }
  
      setInterval(function() {
        _lastpoll = Date.now();
        var url = '/svc/rscvd/poll/' + (_lastpoll - 300000);
        pradm.ajax(url, {
          success: function(res) {
            _polls = res;
            pradm.each('.verifier', function(el) { _vd(el); });
            for (var rec in _polls.new) {
              if (!pradm.exists('#' + rec._id)) pradm.prepend(_construct(rec));
            }
            for ( var s in _polls.status ) {
              var el = pradm.exists('.' + s);
              if (el && pradm.has(el, '.status') && pradm.val(el) !== res.status[s]) {
                pradm.set(el, res.status[s]);
                _state_hide(el);
              }
            }
          }
        });
      }, 10000);
    }
  };
  if (pradm.loggedin()) {
    pradm.afterLogin();
  } else {
    pradm.show('#login');
  }

</script>

